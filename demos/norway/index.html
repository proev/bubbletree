<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="UTF-8"/>
	<title>Norway Country Functional Analysis</title>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
	<script type="text/javascript" src="../../lib/jquery.history.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
	<script type="text/javascript" src="../../lib/vis4.js"></script>
	<script type="text/javascript" src="../../lib/Tween.js"></script>
	<script type="text/javascript" src="../../build/bubbletree.js"></script>
	<script type="text/javascript" src="http://assets.openspending.org/openspendingjs/master/lib/aggregator.js"></script>
	<link rel="stylesheet" type="text/css" href="../../build/bubbletree.css" />
	<script type="text/javascript" src="../../styles/cofog.js"></script>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
	<script type="text/javascript">
		$(function() {
			var $tooltip = $('<div class="tooltip">Tooltip</div>');
			$('.bubbletree').append($tooltip);
			$tooltip.hide();

			var tooltip = function(event) {
				if (event.type == 'SHOW') {
					// show tooltip
					console.log(event);
					$tooltip.css({
						left: event.mousePos.x + 4,
						top: event.mousePos.y + 4
					});
					$tooltip.html(event.node.label+' <b>'+event.node.amount+'</b>');
					var bubble = event.target;

					$tooltip.show();
				} else {
					// hide tooltip
					$tooltip.hide();
				}
			};

			var trimData = function(data) {
				for (var i = 0; i < data["children"].length; i++) {
					if ("cofog1" == data["children"][i]["taxonomy"]) {
						if (parseInt(data["children"][i]["name"]) < 10) {
							data["children"][i]["name"] = "0" + data["children"][i]["name"];
						}
					} else if ("cofog2" == data["children"][i]["taxonomy"]) {
						data["children"][i]["name"] = data["children"][i]["name"].replace("-", ".");
					}
					if (data["children"][i]["children"].length > 0) {
						trimData(data["children"][i]);
					}
				}
			}

			var createViz = function(year) {
				if (year > 1995) {
					new OpenSpending.Aggregator({
						apiUrl: 'http://openspending.org/api',
						dataset: 'norge_offentlig_forvaltning_utgifter_formaal',
						rootNodeLabel: 'Totalt',
						drilldowns: ['cofog1', 'cofog2'],
						cuts: ['year:' + year],
						breakdown: 'time',
						// localApiCache: 'aggregate.json',
						callback: dataLoaded
					});
				}
			}

			var dataLoaded = function(data) {
				$(".bubbletree-wrapper").html("<div class=\"bubbletree\" />")
				
				trimData(data);

				window.bubbleTree = new BubbleTree({
					data: data,
					container: '.bubbletree',
					bubbleType: 'icon',
					bubbleStyles: {
						'cofog1': BubbleTree.Styles.Cofog,
						'cofog2': BubbleTree.Styles.Cofog
					},
					rootPath: '../../',
					sortBy: 'label',
					tooltipCallback: tooltip
				});
			};

			// call openspending api for data
			createViz(2012);
			$("#slider").slider();
			
			$("#slider").slider({
				max:2012,
				min:1996,
				value:2012,
				slide: function(event, ui) {
					console.log(ui);
					$(".currentslide").text(ui.value);
				},
				change: function(event, ui) {
					createViz(ui.value);					
				}
			});

		});

	</script>
	<style>
		.firstyear {position:relative; z-index:1;top:38px;}
		.endyear {text-align:right;}
	</style>
</head>
<body>
	<div id="header">
		<a class="title">OpenSpending</a>
		<div class="subtitle">Norway Country Analysis</div>
		<div class="currentslide">2012</div>
		<div class="firstyear">1996</div>
		<div id="slider"></div>
		<div class="endyear">2012</div>
	</div>
	<div class="bubbletree-wrapper">
		<div class="bubbletree"></div>
	</div>
</body>
</html>
